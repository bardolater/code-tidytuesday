---
title: "Jobs Gender"
author: "Otho"
date:  "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(rlang)
```


```{r}

dat_path <- "data/2-12-open-policing.Rdata"

# data for Raleigh, because I have been there
dat_url <- paste0("https://stacks.stanford.edu/",
                  "file/druid:tr137st9964/tr137st9964",
                  "_nc_raleigh_2019_02_25.csv.zip")

if(!file.exists(dat_path)) {
  # one temporary file zipped
  # and one with the csv
  temp <- tempfile()
  temp2 <- tempfile()
  download.file(dat_url, destfile = temp)
  
  temp2 <- unzip(temp)
  
  raleigh <- read_csv(temp2)
  
  save(raleigh, file = dat_path)
} else {
  load(dat_path)
}
```

# explore

I guess that the `time` variable is measured in seconds of the day

```{r}
raleigh$time %>% range(na.rm = TRUE)
# Time differences in secs
# [1]     1 86399
```

```{r}
day_sec <- 60*60*24

stop_dens <- 
  raleigh %>%  
  # hack: density of circular data
  # https://stackoverflow.com/questions/36266402
  bind_rows(raleigh %>% mutate(time = time - day_sec)) %>% 
  bind_rows(raleigh %>% mutate(time = time + day_sec)) %>% 
  filter(!is.na(time)) %>%  
  pull(time) %>% 
  rlang::as_integer() %>% 
  density(bw = 10^3,
          adjust = 1,
          n = 2^11) %>% 
  {tibble(x = .$x,
          y = .$y)}

med_y <-
  stop_dens %>% 
  filter(x > 0,
         x < day_sec) %>% 
  pull(y) %>% 
  mean()

fill_up <- "#3752C3"
fill_down <- "#B63A82"
colour <- "white"
ytop <- stop_dens$y %>% max()
ylow <- stop_dens$y %>% min()

p <- 
  stop_dens %>% 
  ggplot(aes(x = x,
             ymax = y)) +
  geom_ribbon(data = . %>%
                filter(y > med_y),
              ymin = med_y,
              fill = fill_up,
              colour = colour,
              alpha = .2) +
  geom_ribbon(data = . %>%
                filter(y <= med_y),
              ymin = med_y,
              fill = fill_down,
              colour = colour,
              alpha = .2) +
  coord_polar() +
  lims(x = c(0, day_sec + 3*10e2),
       y = c(-1e-6, NA)) +
  theme_void()
```

```{r}
# Aim at 10 ridges
ridge_width <- stop_dens$y %>% range() %>% {(.[2] - .[1])/10}

up_gradient <- function(roll, p = p) {
  p <- p + 
    geom_ribbon(data = . %>%
                  filter(y > med_y + (ytop - med_y)*(roll/5)),
                aes(x = x,
                    ymin = med_y + (ytop - med_y)*(roll/5),
                    ymax = y),
                fill = fill_up,
                alpha = .3,
                colour = "white",
                size = .4,
                inherit.aes = F)
  return(p)
}


down_gradient <- function(roll, p = p) {
  p <- p + 
    geom_ribbon(data = . %>%
                  filter(y < med_y - (med_y - ylow)*(roll/5)),
                aes(x = x,
                    ymin = med_y - (med_y - ylow)*(roll/5),
                    ymax = y),
                fill = fill_down,
                alpha = .3,
                colour = "white",
                size = .4,
                inherit.aes = F)
  return(p)
}

p2 <- up_gradient(1, p)
p2 <- up_gradient(2, p2)
p2 <- up_gradient(3, p2)
p2 <- up_gradient(4, p2)
p2 <- down_gradient(1, p2)
p2 <- down_gradient(2, p2)
p2 <- down_gradient(3, p2)
p2 <- down_gradient(4, p2)

p3 <- 
  p2 + 
  annotate(geom = "rect",
           xmin = day_sec, xmax = day_sec + 3*10e2,
           ymin = -Inf, ymax = Inf,
           fill = "white") 
p3
```

```{r}
svglite::svglite("plots/2-12-open-policing.svg")
p3
dev.off()
```

