---
title: "Open Policing - Raleigh"
author: "Otho"
date:  "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

Reproduce Nadieh Bremer and Zan Armstrong famouse [Baby Spike visualization](https://www.visualcinnamon.com/portfolio/baby-spike)

```{r}
library(tidyverse)
library(rlang)
```


```{r}
dat_path <- "data/2-12-open-policing.Rdata"

# data for Raleigh, because I have been there
dat_url <- paste0("https://stacks.stanford.edu/",
                  "file/druid:tr137st9964/tr137st9964",
                  "_nc_raleigh_2019_02_25.csv.zip")

if(!file.exists(dat_path)) {
  # one temporary file zipped
  # and one with the csv
  temp <- tempfile()
  temp2 <- tempfile()
  download.file(dat_url, destfile = temp)
  
  temp2 <- unzip(temp)
  
  raleigh <- read_csv(temp2)
  
  save(raleigh, file = dat_path)
} else {
  load(dat_path)
}
```

# explore

I guess that the `time` variable is measured in seconds of the day

```{r}
raleigh$time %>% range(na.rm = TRUE)
# Time differences in secs
# [1]     1 86399
```

```{r}
day_sec <- 60*60*24

stop_dens <- 
  raleigh %>%  
  # hack: density of circular data
  # https://stackoverflow.com/questions/36266402
  bind_rows(raleigh %>% mutate(time = time - day_sec)) %>% 
  bind_rows(raleigh %>% mutate(time = time + day_sec)) %>% 
  filter(!is.na(time)) %>%  
  pull(time) %>% 
  rlang::as_integer() %>% 
  density(bw = 10^3,
          adjust = 1,
          n = 2^11) %>% 
  {tibble(x = .$x,
          y = .$y)}

med_y <-
  stop_dens %>% 
  filter(x > 0,
         x < day_sec) %>% 
  pull(y) %>% 
  mean()

fill_up <- "#3752C3"
fill_down <- "#B63A82"
colour <- "white"
ytop <- stop_dens$y %>% max()
ylow <- stop_dens$y %>% min()
# Aim at 12 ridges
ridge_width <- stop_dens$y %>% range() %>% {(.[2] - .[1])/12}
grid_at <- c(med_y - ridge_width*3,
             med_y,
             med_y + ridge_width*3)
annos_color <- "grey70"

p <- 
  stop_dens %>% 
  ggplot(aes(x = x,
             ymax = y)) +
  geom_ribbon(data = . %>%
                filter(y > med_y),
              ymin = med_y,
              fill = fill_up,
              colour = colour,
              alpha = .2) +
  geom_ribbon(data = . %>%
                filter(y <= med_y),
              ymin = med_y,
              fill = fill_down,
              colour = colour,
              alpha = .2) +
  coord_map(projection = "orthographic") +
  lims(x = c(0, day_sec + 3*10e2),
       y = c(-1e-6, NA)) 
  # theme_void()
p
```

```{r}
up_gradient <- function(roll, p = p) {
  p <- p + 
    geom_ribbon(data = . %>%
                  filter(y > med_y + ridge_width*roll),
                aes(x = x,
                    ymin = med_y + ridge_width*roll,
                    ymax = y),
                fill = fill_up,
                alpha = .3,
                # colour = "white",
                # size = .4,
                inherit.aes = F)
  return(p)
}


down_gradient <- function(roll, p = p) {
  p <- p + 
    geom_ribbon(data = . %>%
                  filter(y < med_y - ridge_width*roll),
                aes(x = x,
                    ymin = med_y - ridge_width*roll,
                    ymax = y),
                fill = fill_down,
                alpha = .3,
                # colour = "white",
                # size = .4,
                inherit.aes = F)
  return(p)
}

p2 <- up_gradient(1, p)
p2 <- up_gradient(2, p2)
p2 <- up_gradient(3, p2)
p2 <- up_gradient(4, p2)
p2 <- down_gradient(1, p2)
p2 <- down_gradient(2, p2)
p2 <- down_gradient(3, p2)
p2 <- down_gradient(4, p2)
p2 <- down_gradient(5, p2)


# Cover up ribbon residues
p3 <- 
  p2 +
  geom_ribbon(data = . %>% 
                mutate(upper_bound = case_when(y < med_y ~ y,
                                               TRUE ~ med_y)),
              aes(ymax = upper_bound,
                  ymin = ylow),
              fill = "white",
              colour = NA) +
  geom_ribbon(data = . %>% 
                mutate(lower_bound = case_when(y > med_y ~ y,
                                               TRUE ~ med_y)),
              aes(ymax = ytop,
                  ymin = lower_bound),
              fill = "white",
              colour = NA) 
  
p3

# add grid
add_grid <- 
  function(at, p = p) {
    if (at > med_y) {
      p <- 
        p + 
        geom_point(data = . %>% 
                     filter(y < at) %>% 
                     {slice(., seq(from = 1, to = n(), by = 5))},
                   y = at,
                   shape = ".",
                   colour = annos_color)
      return(p)
    } else if (at < med_y){
      p <- 
        p + 
        geom_point(data = . %>% 
                     filter(y > at) %>% 
                     {slice(., seq(from = 1, to = n(), by = 10))},
                   y = at,
                   shape = ".",
                   colour = annos_color)
      return(p)
    } else { 
      return(p)}
  }

p4 <- p3
for(i in grid_at) p4 <- add_grid(at = i, p = p4)
p4

# white space at x=0
# and line at mean y
p5 <- 
  p4 + 
  geom_hline(yintercept = med_y,
             colour =  "#0FE8FF") + #"#83D2FF" ) +
  annotate(geom = "rect",
           xmin = day_sec, xmax = day_sec + 3*10e2,
           ymin = -Inf, ymax = Inf,
           fill = "white") 
p5

# add y guide
p6 <- 
  p5 + 
  geom_text(data = tibble(x = 0,
                          y = grid_at),
            aes(x = x, y = y,
                label = y %>% scales::scientific(digits = 1)),
            size = 3,
            hjust = 1,
            vjust = 0,
            colour = annos_color,
            inherit.aes = F) 

p6
```

```{r}
svglite::svglite("plots/2-12-open-policing.svg")
p6
dev.off()
```

# otherwise, map coordinates

```{r}
library(scales)

stop_coord <- 
  stop_dens %>% 
  filter(x > 0, x < 60*60*24) %>% 
  mutate(x = rescale(x, to = c(100, -10), from = range(x)),
         y = rescale(y, to = c(70, 20), from = c(0, max(y))))

fill_up <- "#3752C3"
fill_down <- "#B63A82"
colour <- "white"
ytop <- stop_coord$y %>% max()
ylow <- stop_coord$y %>% min()
med_y <- stop_coord$y %>% mean()
# Aim at 12 ridges
ridge_width <- stop_dens$y %>% range() %>% {(.[2] - .[1])/12}
grid_at <- c(med_y - ridge_width*3,
             med_y,
             med_y + ridge_width*3)
annos_color <- "grey70"

stop_coord %>%
  ggplot(aes(x = x,
             y = y)) +
  geom_ribbon(aes(ymin = med_y,
                  ymax = y)) +
  coord_map(projection = "azequidistant", orientation = c(90, 0, 225)) +
  # theme_minimal()
  theme_void()
```

