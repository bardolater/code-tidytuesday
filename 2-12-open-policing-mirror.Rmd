---
title: "Open Policing - Raleigh"
author: "Otho"
date:  "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(rlang)
library(lubridate)
library(scales)

# weekdays in english
Sys.setlocale("LC_TIME", "en_US.UTF8")
```


```{r}
dat_path <- "data/2-12-open-policing.Rdata"

# data for Raleigh, because I have been there
dat_url <- paste0("https://stacks.stanford.edu/",
                  "file/druid:tr137st9964/tr137st9964",
                  "_nc_raleigh_2019_02_25.csv.zip")

if(!file.exists(dat_path)) {
  # one temporary file zipped
  # and one with the csv
  temp <- tempfile()
  temp2 <- tempfile()
  download.file(dat_url, destfile = temp)
  
  temp2 <- unzip(temp)
  
  raleigh <- read_csv(temp2)
  
  save(raleigh, file = dat_path)
} else {
  load(dat_path)
}
```

# explore

I guess that the `time` variable is measured in seconds of the day

```{r}
raleigh$time %>% range(na.rm = TRUE)
# Time differences in secs
# [1]     1 86399
```

# Use loess.

```{r}
day_sec <- 60*60*24

# how many weeks in the dataset?
week_span <- raleigh$date %>%
  {lubridate::interval(start = min(.), end = max(.))} %>% 
  time_length()/(24*60*60*7) %>% 
  round()



# bin stops per minute
by_minute <- 
  raleigh %>%  
  mutate(mins = as_double(time) %/% 60,
         weekday = weekdays(date)) %>% 
  group_by(mins, weekday) %>% 
  count() %>% 
  # na.omit() %>%
  # strange measurements at 0
  # probably tecnical issue
  filter(mins > 0) %>% 
  # devide by weeks in dataset
  mutate(n = n/week_span)


# check
# span <- 1/30
span <- 1/20
by_minute %>% 
  ggplot(aes(x = mins, y = n)) +
  stat_smooth(method = "loess", span = span) +
  geom_point(shape = ".") +
  facet_grid(weekday ~ .)

by_mins_list <- 
  by_minute %>% 
  split(.$weekday)

# smooth 
smooth_obj <- 
 by_mins_list %>% 
  map(., ~loess(formula = "n ~ mins",
         data = .,
         span = span))


# prediction
preds <- 
  smooth_obj %>% 
  map(., ~predict(., se = T))
  
# join fitted values and 
# original data
min_smooth <- 
  names(preds) %>% 
  map(.x = .,
      .f = ~preds[[.x]] %>% 
      {tibble(mins = names(.$fit) %>% as.numeric(),
              fitted = .$fit,
              se = .$se,
              weekday = .x)} %>% 
        full_join(by_mins_list[[.x]])) %>% 
  reduce(bind_rows) %>% 
  # reset weekdays order %>% 
  mutate(weekday = factor(weekday, 
                          levels = c("Sunday", 
                                     "Monday",
                                     "Tuesday",
                                     "Wednesday",
                                     "Thursday",
                                     "Friday",
                                     "Saturday"))) %>% 
  # label mins and max
  group_by(weekday) %>% 
  mutate(min_max = case_when(fitted == max(fitted) ~ TRUE,
                             fitted == min(fitted) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  ungroup()

# check
min_smooth %>% 
  ggplot(aes(x = mins, y = n)) +
  geom_line(aes(y = fitted)) +
  geom_point(shape = ".") +
  facet_grid(weekday ~ .)


# try ribbon
med_y <- mean(min_smooth$n)

# cool, a bit by chance
p <- 
  min_smooth %>% 
  ggplot(aes(x = mins)) +
  geom_hline(yintercept = med_y,
             colour = "#B63A82") +
  geom_ribbon(aes(ymin = med_y,
                  ymax = fitted),
              fill = "grey80",
             colour = "#27A6D3") +
  geom_point(aes(y = n),
             shape = ".") +
  ylim(0, NA) +
  theme_minimal()
p

p + facet_grid(weekday ~ .)

fill_up <- "#3752C3"
```

# Try mirror

```{r}
p <- 
  min_smooth %>% 
  mutate(fitted = fitted - med_y,
         verso = case_when(fitted > 0 ~ "up",
                           TRUE ~ "down"),
         fitted = abs(fitted)) %>% 
  ggplot(aes(x = mins)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = 0,
                  ymax = fitted,
                  fill = verso),
              colour = "grey50") +
  facet_grid(weekday ~ .) +
  scale_fill_manual(values = c(down = "#4C63C3DD", up = "#FF6C0DDD")) +
  lims(y = c(0, 0.12)) +
  theme_bw()

p
```

#  label local maxima

```{r}
p1 <- 
  p + 
  geom_text(data = . %>% 
              filter(min_max) %>% 
              mutate(signed = case_when(verso == "up" ~ fitted,
                                  TRUE ~ -(fitted))),
            aes(y = fitted,
                label = signed %>% 
                  round(2)),
            colour = "grey15",
            fontface = "italic",
            vjust = 0,
            hjust = 0.2,
            size = 3,
            nudge_y = .005)

p1
```

